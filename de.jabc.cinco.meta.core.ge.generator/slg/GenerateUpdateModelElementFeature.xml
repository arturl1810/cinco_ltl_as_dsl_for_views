<?xml version="1.0" encoding="ISO-8859-1"?>
<model version="2.1">
  <id>ef7786c5-d04b-45de-89fd-b00e68b99149</id>
  <name>GenerateUpdateModelElementFeature</name>
  <changecounter>343</changecounter>
  <sib>
    <id>b31345f6-8607-4397-986e-94a14e803be6</id>
    <name>PutExpression_1</name>
    <label>PkgName</label>
    <sib-uid>basic-sibs/PutExpression</sib-uid>
    <taxonomy>de.jabc.sib.common.basic.PutExpression</taxonomy>
    <position>71.5,33.0</position>
    <parameter name="resolve">
      <boolean>true</boolean>
    </parameter>
    <parameter name="value">
      <de.metaframe.common.sib.parameter.ContextExpression>
        <ContextExpressionFoundation>
          <expression>${packageName}.graphiti.features.update</expression>
          <clazz>java.lang.Object</clazz>
          <classMutable>true</classMutable>
        </ContextExpressionFoundation>
      </de.metaframe.common.sib.parameter.ContextExpression>
    </parameter>
    <parameter name="variable">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>localPkgName</key>
          <scope>LOCAL</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <finalbranches>default</finalbranches>
    <finalbranches>error</finalbranches>
    <userobject key="ABC$START">
      <boolean>true</boolean>
    </userobject>
  </sib>
  <edge>
    <source>b31345f6-8607-4397-986e-94a14e803be6</source>
    <target>cee0f62d-0478-473a-a434-74d5c44e76fe</target>
    <point>121.875,129.0</point>
    <point>220.0,227.33333333333331</point>
    <labelposition>500.0,0.0</labelposition>
    <branch>default</branch>
  </edge>
  <sib>
    <id>2d8daa31-0f3d-4e6c-ad49-8a0f91c78076</id>
    <name>RunStringTemplate</name>
    <label>RunStringTemplate</label>
    <sib-uid>script-sibs/RunStringTemplate</sib-uid>
    <taxonomy>de.jabc.sib.common.script.RunStringTemplate</taxonomy>
    <position>40.0,483.0</position>
    <parameter name="append">
      <boolean>false</boolean>
    </parameter>
    <parameter name="individualVariables">
      <boolean>false</boolean>
    </parameter>
    <parameter name="result">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>updateModelElementFeatureContent</key>
          <scope>LOCAL</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <parameter name="template">
      <string>package $context.localPkgName$;

import org.eclipse.emf.ecore.*;
import org.eclipse.graphiti.features.*;
import org.eclipse.graphiti.features.context.*;
import org.eclipse.graphiti.features.context.impl.LayoutContext;
import org.eclipse.graphiti.features.impl.*;
import org.eclipse.graphiti.mm.algorithms.*;
import org.eclipse.graphiti.mm.pictograms.*;
import org.eclipse.graphiti.services.*;

$context.appearanceProviderImportsContent$

import $context.packageName$.graphiti.*;
import $context.importPath$.*;
import $context.packageName$.graphiti.expression.*;

import de.jabc.cinco.meta.core.referenceregistry.ReferenceRegistry;

import com.sun.el.ExpressionFactoryImpl;

public class $context.className$ extends AbstractUpdateFeature {

	private static ExpressionFactoryImpl factory = new ExpressionFactoryImpl();
	private static ExpressionLanguageContext elContext;

	public $context.className$(IFeatureProvider fp) {
		super(fp);
	}

	@Override
	public boolean canUpdate(IUpdateContext context) {
		PictogramElement pe = context.getPictogramElement();
		EObject bo = Graphiti.getLinkService().getBusinessObjectForLinkedPictogramElement(pe);
		return (bo instanceof $context.fuModelElementName$);
	}

	@Override
	public IReason updateNeeded(IUpdateContext context) {
		PictogramElement pe = context.getPictogramElement();
		$context.fuModelElementName$ bo =($context.fuModelElementName$) Graphiti.getLinkService().getBusinessObjectForLinkedPictogramElement(pe);
		if (checkUpdateNeeded(bo, pe))
			return Reason.createTrueReason();
		return Reason.createFalseReason();
	}

	@Override
	public boolean update(IUpdateContext context) {
		PictogramElement pe = context.getPictogramElement();
		$context.fuModelElementName$ bo = ($context.fuModelElementName$) Graphiti.getLinkService().getBusinessObjectForLinkedPictogramElement(pe);
		updateText(bo, pe);
		$context.appearanceProviderExtensionContent$
		LayoutContext lContext = new LayoutContext(context.getPictogramElement());
		ILayoutFeature lf = getFeatureProvider().getLayoutFeature(lContext);
		if (lf.canLayout(lContext)) {
			return lf.layout(lContext);
		}		

		return false;
	}
	
	private void updateText($context.fuModelElementName$ $context.meIdentifier$, PictogramElement pe) {
		if (pe instanceof ContainerShape) {
			PictogramElement tmp = pe.getGraphicsAlgorithm().getPictogramElement();
			Object o = Graphiti.getLinkService().getBusinessObjectForLinkedPictogramElement(tmp);
			if ($context.meIdentifier$.equals(o) || o == null)
			for (Shape s : ((ContainerShape) pe).getChildren()) {
				updateText($context.meIdentifier$, s);
			}
		} 
		if (pe instanceof Connection) {
			Connection connection = (Connection) pe;
			for (ConnectionDecorator cd : connection.getConnectionDecorators()) {
				updateText($context.meIdentifier$, cd);
			}
		} else {
			if (pe.getGraphicsAlgorithm() instanceof AbstractText) {
				AbstractText t = (AbstractText) pe.getGraphicsAlgorithm();
				$context.elCode$
				String formatString = Graphiti.getPeService().getPropertyValue(t, $context.graphModelName$GraphitiUtils.KEY_FORMAT_STRING);
				t.setValue(String.format(formatString $context.formatParameter$));
			}
		}
	}

	public static boolean checkUpdateNeeded($context.fuModelElementName$ $context.meIdentifier$, PictogramElement pe) {
		boolean updateNeeded;
		if (pe instanceof ContainerShape) {
			for (Shape s : ((ContainerShape) pe).getChildren()) {
				return checkUpdateNeeded($context.meIdentifier$, s);
			}
		} 
		if (pe instanceof Connection) {
			Connection connection = (Connection) pe;
			for (ConnectionDecorator cd : connection.getConnectionDecorators()) {
				updateNeeded = checkUpdateNeeded($context.meIdentifier$, cd);
				if (updateNeeded)
					return true;
			}
		} else {
			Object o = Graphiti.getLinkService().getBusinessObjectForLinkedPictogramElement(pe);
			if (pe.getGraphicsAlgorithm() instanceof AbstractText &amp;&amp; $context.meIdentifier$.equals(o)) {
				AbstractText t = (AbstractText) pe.getGraphicsAlgorithm();
				$context.elCode$
				String formatString = Graphiti.getPeService().getPropertyValue(t, $context.graphModelName$GraphitiUtils.KEY_FORMAT_STRING);
				String oldVal = String.format(formatString $context.formatParameter$);
				String newVal = t.getValue();
				return (!newVal.equals(oldVal));
			}
		}
		return false;
	}

	$context.updateProviderContent$
}	
	</string>
    </parameter>
    <finalbranches>default</finalbranches>
    <finalbranches>error</finalbranches>
  </sib>
  <edge>
    <source>2d8daa31-0f3d-4e6c-ad49-8a0f91c78076</source>
    <target>773a72fb-bb20-4d89-ac0c-24e90ff28244</target>
    <point>105.0,915.0</point>
    <point>315.0,915.0</point>
    <labelposition>500.0,0.0</labelposition>
    <branch>default</branch>
  </edge>
  <sib>
    <id>773a72fb-bb20-4d89-ac0c-24e90ff28244</id>
    <name>WriteJavaFile</name>
    <label>WriteJavaFile</label>
    <sib-uid>genesys-sibs/WriteJavaFile</sib-uid>
    <taxonomy>de.jabc.sib.genesys.WriteJavaFile</taxonomy>
    <position>58.0,618.0</position>
    <parameter name="baseDirectory">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>outletPath</key>
          <scope>GLOBAL</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <parameter name="beautify">
      <boolean>false</boolean>
    </parameter>
    <parameter name="beautifyMethod">
      <de.metaframe.common.sib.parameter.ListBox>
        <ListBoxFoundation>
          <list>
            <string>Eclipse</string>
            <string>Jalopy</string>
          </list>
          <selected>0</selected>
        </ListBoxFoundation>
      </de.metaframe.common.sib.parameter.ListBox>
    </parameter>
    <parameter name="className">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>className</key>
          <scope>LOCAL</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <parameter name="fileContent">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>updateModelElementFeatureContent</key>
          <scope>LOCAL</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <parameter name="packageName">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>localPkgName</key>
          <scope>LOCAL</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <finalbranches>default</finalbranches>
    <finalbranches>error</finalbranches>
  </sib>
  <edge>
    <source>1ac648f9-a87e-4bb7-b05b-c181161fa01e</source>
    <target>2d8daa31-0f3d-4e6c-ad49-8a0f91c78076</target>
    <point>105.0,765.0</point>
    <point>105.0,915.0</point>
    <labelposition>500.0,0.0</labelposition>
    <branch>exit</branch>
  </edge>
  <sib>
    <id>1ac648f9-a87e-4bb7-b05b-c181161fa01e</id>
    <name>GraphSIB</name>
    <label>GenerateGetTextValues</label>
    <sib-uid>00000000:00000000000000000000:0000000000011</sib-uid>
    <taxonomy>de.metaframe.jabc.sib.GraphSIB</taxonomy>
    <position>28.5,361.0</position>
    <parameter name="modelElementKey">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>modelElement</key>
          <scope>DECLARED</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <finalbranches>error</finalbranches>
    <finalbranches>exit</finalbranches>
    <userobject key="ABC$GRAPHSIB$MODELID">
      <string>2a28c6a3-7550-4d5b-a8c5-c31758cd1dd2</string>
    </userobject>
    <userobject key="ABC$GRAPHSIB$MODELNAME">
      <string>GenerateGetTextValues2</string>
    </userobject>
  </sib>
  <sib>
    <id>cee0f62d-0478-473a-a434-74d5c44e76fe</id>
    <name>GraphSIB_1</name>
    <label>CheckStyleAnnotation</label>
    <sib-uid>00000000:00000000000000000000:0000000000011</sib-uid>
    <taxonomy>de.metaframe.jabc.sib.GraphSIB</taxonomy>
    <position>32.0,136.0</position>
    <parameter name="modelElementKey">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>modelElement</key>
          <scope>DECLARED</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <finalbranches>default</finalbranches>
    <finalbranches>error</finalbranches>
    <userobject key="ABC$GRAPHSIB$MODELID">
      <string>843b7fe1-9b8e-4b49-94ab-777e60336bda</string>
    </userobject>
    <userobject key="ABC$GRAPHSIB$MODELNAME">
      <string>CheckStyleAnnotation</string>
    </userobject>
  </sib>
  <edge>
    <source>cee0f62d-0478-473a-a434-74d5c44e76fe</source>
    <target>bcee566b-931c-475a-b37b-40e81d64623f</target>
    <point>113.6021505376344,176.0</point>
    <point>216.72413793103448,408.0</point>
    <labelposition>500.0,0.0</labelposition>
    <branch>default</branch>
  </edge>
  <sib>
    <id>bcee566b-931c-475a-b37b-40e81d64623f</id>
    <name>PutExpression_2</name>
    <label>ClassName</label>
    <sib-uid>basic-sibs/PutExpression</sib-uid>
    <taxonomy>de.jabc.sib.common.basic.PutExpression</taxonomy>
    <position>65.5,258.0</position>
    <parameter name="resolve">
      <boolean>true</boolean>
    </parameter>
    <parameter name="value">
      <de.metaframe.common.sib.parameter.ContextExpression>
        <ContextExpressionFoundation>
          <expression>Update${fuModelElementName}Feature</expression>
          <clazz>java.lang.Object</clazz>
          <classMutable>true</classMutable>
        </ContextExpressionFoundation>
      </de.metaframe.common.sib.parameter.ContextExpression>
    </parameter>
    <parameter name="variable">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>className</key>
          <scope>LOCAL</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <finalbranches>default</finalbranches>
    <finalbranches>error</finalbranches>
  </sib>
  <edge>
    <source>bcee566b-931c-475a-b37b-40e81d64623f</source>
    <target>1ac648f9-a87e-4bb7-b05b-c181161fa01e</target>
    <point>120.0,390.0</point>
    <point>91.0,784.0</point>
    <branch>default</branch>
  </edge>
  <parameter>
    <name>modelElementKey</name>
    <field>modelElementKey</field>
    <sib>1ac648f9-a87e-4bb7-b05b-c181161fa01e</sib>
  </parameter>
  <parameter>
    <name>modelElementKey</name>
    <field>modelElementKey</field>
    <sib>cee0f62d-0478-473a-a434-74d5c44e76fe</sib>
  </parameter>
  <values>
    <entry>
      <string>modelElementKey</string>
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>modelElement</key>
          <scope>DECLARED</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </entry>
  </values>
  <branch>
    <name>error</name>
    <branch>error</branch>
    <sib>b31345f6-8607-4397-986e-94a14e803be6</sib>
  </branch>
  <branch>
    <name>error</name>
    <branch>error</branch>
    <sib>2d8daa31-0f3d-4e6c-ad49-8a0f91c78076</sib>
  </branch>
  <branch>
    <name>error</name>
    <branch>error</branch>
    <sib>773a72fb-bb20-4d89-ac0c-24e90ff28244</sib>
  </branch>
  <branch>
    <name>default</name>
    <branch>default</branch>
    <sib>773a72fb-bb20-4d89-ac0c-24e90ff28244</sib>
  </branch>
  <branch>
    <name>error</name>
    <branch>error</branch>
    <sib>1ac648f9-a87e-4bb7-b05b-c181161fa01e</sib>
  </branch>
  <branch>
    <name>error</name>
    <branch>error</branch>
    <sib>cee0f62d-0478-473a-a434-74d5c44e76fe</sib>
  </branch>
  <branch>
    <name>error</name>
    <branch>error</branch>
    <sib>bcee566b-931c-475a-b37b-40e81d64623f</sib>
  </branch>
</model>