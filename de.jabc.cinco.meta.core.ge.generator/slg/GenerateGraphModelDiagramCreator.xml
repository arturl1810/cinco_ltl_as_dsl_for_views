<?xml version="1.0" encoding="ISO-8859-1"?>
<model version="2.1">
  <id>bc163f1e-0219-4ee4-b1a8-2864de76b1af</id>
  <name>GenerateGraphModelDiagramCreator</name>
  <changecounter>72</changecounter>
  <sib>
    <id>ad9b9c21-91db-4af5-9d2c-291ad1a050ef</id>
    <name>PutExpression</name>
    <label>LocalPkgName</label>
    <sib-uid>basic-sibs/PutExpression</sib-uid>
    <taxonomy>de.jabc.sib.common.basic.PutExpression</taxonomy>
    <position>39.5,48.0</position>
    <parameter name="resolve">
      <boolean>true</boolean>
    </parameter>
    <parameter name="value">
      <de.metaframe.common.sib.parameter.ContextExpression>
        <ContextExpressionFoundation>
          <expression>${packageName}.graphiti</expression>
          <clazz>java.lang.Object</clazz>
          <classMutable>true</classMutable>
        </ContextExpressionFoundation>
      </de.metaframe.common.sib.parameter.ContextExpression>
    </parameter>
    <parameter name="variable">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>localPkgName</key>
          <scope>LOCAL</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <finalbranches>default</finalbranches>
    <finalbranches>error</finalbranches>
    <userobject key="ABC$START">
      <boolean>true</boolean>
    </userobject>
  </sib>
  <edge>
    <source>ad9b9c21-91db-4af5-9d2c-291ad1a050ef</source>
    <target>b316cc76-c376-4517-9225-83d1324e2a57</target>
    <point>75.0,75.0</point>
    <point>480.0,75.0</point>
    <labelposition>500.0,0.0</labelposition>
    <branch>default</branch>
  </edge>
  <sib>
    <id>b316cc76-c376-4517-9225-83d1324e2a57</id>
    <name>PutExpression_1</name>
    <label>ClassName</label>
    <sib-uid>basic-sibs/PutExpression</sib-uid>
    <taxonomy>de.jabc.sib.common.basic.PutExpression</taxonomy>
    <position>50.5,153.0</position>
    <parameter name="resolve">
      <boolean>true</boolean>
    </parameter>
    <parameter name="value">
      <de.metaframe.common.sib.parameter.ContextExpression>
        <ContextExpressionFoundation>
          <expression>Create${graphModelName}Diagram</expression>
          <clazz>java.lang.Object</clazz>
          <classMutable>true</classMutable>
        </ContextExpressionFoundation>
      </de.metaframe.common.sib.parameter.ContextExpression>
    </parameter>
    <parameter name="variable">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>className</key>
          <scope>LOCAL</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <finalbranches>default</finalbranches>
    <finalbranches>error</finalbranches>
  </sib>
  <sib>
    <id>ce391528-54d4-4875-a460-bda3725e4ff3</id>
    <name>RunStringTemplate</name>
    <label>DiagramCreatorAction</label>
    <sib-uid>script-sibs/RunStringTemplate</sib-uid>
    <taxonomy>de.jabc.sib.common.script.RunStringTemplate</taxonomy>
    <position>15.5,273.0</position>
    <parameter name="append">
      <boolean>true</boolean>
    </parameter>
    <parameter name="individualVariables">
      <boolean>false</boolean>
    </parameter>
    <parameter name="result">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>CreateDiagramActionContent</key>
          <scope>LOCAL</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <parameter name="template">
      <string>package $context.localPkgName$;

import java.io.IOException;

import org.eclipse.core.resources.IFile;
import org.eclipse.emf.common.util.URI;
import org.eclipse.emf.ecore.resource.Resource;
import org.eclipse.emf.ecore.resource.ResourceSet;
import org.eclipse.emf.ecore.resource.impl.ResourceSetImpl;
import org.eclipse.emf.transaction.TransactionalEditingDomain;
import org.eclipse.emf.transaction.util.TransactionUtil;
import org.eclipse.graphiti.mm.pictograms.Diagram;
import org.eclipse.graphiti.services.Graphiti;
import org.eclipse.jface.action.IAction;
import org.eclipse.jface.dialogs.MessageDialog;
import org.eclipse.jface.viewers.ISelection;
import org.eclipse.jface.viewers.IStructuredSelection;
import org.eclipse.swt.widgets.Display;
import org.eclipse.ui.IActionDelegate;



public class Create$context.graphModelName$Diagram implements IActionDelegate {

	private ISelection sel;
	private $context.importPath$.$context.graphModelName$ gm;
	private Diagram diagram;
	
	public Create$context.graphModelName$Diagram() {
	}

	@Override
	public void run(IAction action) {
		if (sel instanceof IStructuredSelection) {
			IStructuredSelection ssel = (IStructuredSelection) sel;
			if (!ssel.isEmpty() &amp;&amp; ssel.getFirstElement() instanceof IFile) {
				IFile file = (IFile) ssel.getFirstElement();
				URI fileUri = URI.createPlatformResourceURI(file.getFullPath().toOSString(), true);
				
				Resource res = new ResourceSetImpl().getResource(fileUri, true);
				if (res != null) {
					for (Object o : res.getContents()) {
						if (o instanceof $context.importPath$.$context.graphModelName$) {
							gm = ($context.importPath$.$context.graphModelName$) o;
						}
						if (o instanceof Diagram) {
							diagram = (Diagram) o;
						}
					}
				}
				
				if (gm == null) {
					MessageDialog.openError(Display.getCurrent().getActiveShell(), 
							&quot;Error&quot;, 
							&quot;No $context.graphModelName$ model in file: &quot; + file.getName());
					return;
				}
				
				if (diagram != null) {
					boolean yes = MessageDialog.openQuestion(Display.getCurrent().getActiveShell(), &quot;Warning&quot;,
							&quot;There already exists a diagram for $context.graphModelName$. Do you want to override it?&quot;);
					if (!yes)
						return;
				}
				diagram = Graphiti.getPeService().createDiagram(&quot;$context.graphModelName$&quot;, file.getName().split(&quot;\\\.&quot;)[0], true);
				
				try {
					
					res = gm.eResource();
					res.getContents().clear();
					res.getContents().add(diagram);
					res.getContents().add(gm);
					ResourceSet rs = res.getResourceSet();
					TransactionalEditingDomain dom = TransactionUtil.getEditingDomain(rs);
					if (dom == null) {
						dom = TransactionalEditingDomain.Factory.INSTANCE.createEditingDomain(rs);
					}
					
					$context.graphModelName$Creator command = new $context.graphModelName$Creator(dom, gm, diagram);
					
					dom.getCommandStack().execute(command);
					
					res.save(null);
					
					dom.dispose();
				} catch (IOException e) {
					e.printStackTrace();
				} 
			}
		}
	}

	@Override
	public void selectionChanged(IAction action, ISelection selection) {
		this.sel = selection;
	}

}
</string>
    </parameter>
    <finalbranches>default</finalbranches>
    <finalbranches>error</finalbranches>
  </sib>
  <edge>
    <source>b316cc76-c376-4517-9225-83d1324e2a57</source>
    <target>ce391528-54d4-4875-a460-bda3725e4ff3</target>
    <point>75.0,195.0</point>
    <point>71.0,298.0</point>
    <branch>default</branch>
  </edge>
  <sib>
    <id>566db424-57e3-4760-be04-5c0e76bb3f60</id>
    <name>WriteJavaFile</name>
    <label>WriteJavaFile</label>
    <sib-uid>genesys-sibs/WriteJavaFile</sib-uid>
    <taxonomy>de.jabc.sib.genesys.WriteJavaFile</taxonomy>
    <position>43.0,378.0</position>
    <parameter name="baseDirectory">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>outletPath</key>
          <scope>GLOBAL</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <parameter name="beautify">
      <boolean>false</boolean>
    </parameter>
    <parameter name="beautifyMethod">
      <de.metaframe.common.sib.parameter.ListBox>
        <ListBoxFoundation>
          <list>
            <string>Eclipse</string>
            <string>Jalopy</string>
          </list>
          <selected>0</selected>
        </ListBoxFoundation>
      </de.metaframe.common.sib.parameter.ListBox>
    </parameter>
    <parameter name="className">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>className</key>
          <scope>LOCAL</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <parameter name="fileContent">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>CreateDiagramActionContent</key>
          <scope>LOCAL</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <parameter name="packageName">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>localPkgName</key>
          <scope>LOCAL</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <finalbranches>default</finalbranches>
    <finalbranches>error</finalbranches>
  </sib>
  <edge>
    <source>ce391528-54d4-4875-a460-bda3725e4ff3</source>
    <target>566db424-57e3-4760-be04-5c0e76bb3f60</target>
    <point>75.0,300.0</point>
    <point>78.0,411.0</point>
    <branch>default</branch>
  </edge>
  <sib>
    <id>8b9c1b28-46c3-4300-a29e-40a8255f0449</id>
    <name>RunStringTemplate_1</name>
    <label>DiagramCreator</label>
    <sib-uid>script-sibs/RunStringTemplate</sib-uid>
    <taxonomy>de.jabc.sib.common.script.RunStringTemplate</taxonomy>
    <position>170.5,498.0</position>
    <parameter name="append">
      <boolean>true</boolean>
    </parameter>
    <parameter name="individualVariables">
      <boolean>false</boolean>
    </parameter>
    <parameter name="result">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>DiagramCreatorContent</key>
          <scope>LOCAL</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <parameter name="template">
      <string>package $context.localPkgName$;

import graphmodel.*;

import java.util.HashMap;

import org.eclipse.emf.transaction.RecordingCommand;
import org.eclipse.emf.transaction.TransactionalEditingDomain;
import org.eclipse.graphiti.dt.IDiagramTypeProvider;
import org.eclipse.graphiti.features.IAddFeature;
import org.eclipse.graphiti.features.IFeatureProvider;
import org.eclipse.graphiti.features.context.impl.AddConnectionContext;
import org.eclipse.graphiti.features.context.impl.AddContext;
import org.eclipse.graphiti.features.context.impl.AreaContext;
import org.eclipse.graphiti.mm.pictograms.Anchor;
import org.eclipse.graphiti.mm.pictograms.ContainerShape;
import org.eclipse.graphiti.mm.pictograms.Diagram;
import org.eclipse.graphiti.mm.pictograms.PictogramElement;
import org.eclipse.graphiti.ui.services.GraphitiUi;


public class $context.graphModelName$Creator extends RecordingCommand{
	
	private Diagram d;
	private $context.importPath$.$context.graphModelName$ gm;

	
	public $context.graphModelName$Creator(TransactionalEditingDomain domain) {
		super(domain);
	}

	public $context.graphModelName$Creator(TransactionalEditingDomain domain, $context.importPath$.$context.graphModelName$ gm, Diagram diagrm) {
		super(domain);
		this.d = diagrm;
		this.gm = gm;
	}
	

	@Override
	protected void doExecute() {
		IDiagramTypeProvider dtp = GraphitiUi.getExtensionManager().createDiagramTypeProvider(d,
				&quot;$context.packageName$.$context.graphModelName$DiagramTypeProvider&quot;);
		IFeatureProvider fp = dtp.getFeatureProvider();
		
		fp.link(d, gm);
		
		HashMap&lt;Object, ContainerShape&gt; addedElements = new HashMap&lt;Object, ContainerShape&gt;();
		int x = 0;
		for (Node n : gm.getAllNodes()) {
			if (n.getContainer() != null &amp;&amp; n.getContainer() instanceof $context.importPath$.$context.graphModelName$) {
				AreaContext ac = new AreaContext();
				ac.setLocation(x, 10);
				AddContext addContext = new AddContext(ac, n);
				addContext.setTargetContainer(d);
				IAddFeature af = fp.getAddFeature(addContext);
				if (af != null &amp;&amp; af.canAdd(addContext)) {
					ContainerShape cs = (ContainerShape) af.add(addContext);
					addedElements.put(n, cs);
				}
				x += 150;
			}
		}

		for (Container nc : gm.getAllContainers()) {
			AreaContext ac = new AreaContext();
			ac.setLocation(x, 10);
			AddContext addContext = new AddContext(ac, nc);
			addContext.setTargetContainer(d);
			IAddFeature af = fp.getAddFeature(addContext);
			if (af != null &amp;&amp; af.canAdd(addContext)) {
				ContainerShape cs = (ContainerShape) af.add(addContext);
				addedElements.put(nc, cs);
				int i = 0;
				for (Node n : nc.getModelElements(Node.class)) {
					ac = new AreaContext();
					ac.setLocation(i+=5, 10);
					addContext = new AddContext(ac, n);
					addContext.setTargetContainer(cs);
					af = fp.getAddFeature(addContext);
					if (af != null &amp;&amp; af.canAdd(addContext)) {
						ContainerShape nodeContainerCS = (ContainerShape) af.add(addContext);
						addedElements.put(n, nodeContainerCS);
					}
					x += 150;
				}
			}
			x += 150;
			
		}
		
		for (Edge e : gm.getAllEdges()){
			Anchor ta = null, sa = null;
			ContainerShape cs;
			cs = addedElements.get(e.getTargetElement());
			if (cs != null) {
				ta = cs.getAnchors().get(0);
				cs = null;
			}
			cs = addedElements.get(e.getSourceElement());
			if (cs != null) {
				sa = cs.getAnchors().get(0);
			}
			
			AddConnectionContext acc = new AddConnectionContext(sa, ta);
			acc.setNewObject(e);
			acc.setTargetContainer(d);
			IAddFeature af = fp.getAddFeature(acc);
			if (af != null &amp;&amp; af.canAdd(acc)) {
				PictogramElement pe = af.add(acc);
			}
			
		}
	}
	
}
</string>
    </parameter>
    <finalbranches>default</finalbranches>
    <finalbranches>error</finalbranches>
  </sib>
  <edge>
    <source>566db424-57e3-4760-be04-5c0e76bb3f60</source>
    <target>13f56336-847c-41e9-979b-1b6c73dc23e5</target>
    <point>75.0,429.0</point>
    <point>75.0,498.0</point>
    <labelposition>500.0,0.0</labelposition>
    <branch>default</branch>
  </edge>
  <sib>
    <id>2794558b-06bd-4d2f-905c-53bab38863fa</id>
    <name>WriteJavaFile_1</name>
    <label>WriteJavaFile</label>
    <sib-uid>genesys-sibs/WriteJavaFile</sib-uid>
    <taxonomy>de.jabc.sib.genesys.WriteJavaFile</taxonomy>
    <position>178.0,378.0</position>
    <parameter name="baseDirectory">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>outletPath</key>
          <scope>GLOBAL</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <parameter name="beautify">
      <boolean>false</boolean>
    </parameter>
    <parameter name="beautifyMethod">
      <de.metaframe.common.sib.parameter.ListBox>
        <ListBoxFoundation>
          <list>
            <string>Eclipse</string>
            <string>Jalopy</string>
          </list>
          <selected>0</selected>
        </ListBoxFoundation>
      </de.metaframe.common.sib.parameter.ListBox>
    </parameter>
    <parameter name="className">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>className</key>
          <scope>LOCAL</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <parameter name="fileContent">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>DiagramCreatorContent</key>
          <scope>LOCAL</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <parameter name="packageName">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>localPkgName</key>
          <scope>LOCAL</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <finalbranches>default</finalbranches>
    <finalbranches>error</finalbranches>
  </sib>
  <edge>
    <source>8b9c1b28-46c3-4300-a29e-40a8255f0449</source>
    <target>2794558b-06bd-4d2f-905c-53bab38863fa</target>
    <point>75.0,525.0</point>
    <point>210.0,517.0</point>
    <branch>default</branch>
  </edge>
  <sib>
    <id>13f56336-847c-41e9-979b-1b6c73dc23e5</id>
    <name>PutExpression_2</name>
    <label>ClassName</label>
    <sib-uid>basic-sibs/PutExpression</sib-uid>
    <taxonomy>de.jabc.sib.common.basic.PutExpression</taxonomy>
    <position>50.5,498.0</position>
    <parameter name="resolve">
      <boolean>true</boolean>
    </parameter>
    <parameter name="value">
      <de.metaframe.common.sib.parameter.ContextExpression>
        <ContextExpressionFoundation>
          <expression>${graphModelName}Creator</expression>
          <clazz>java.lang.Object</clazz>
          <classMutable>true</classMutable>
        </ContextExpressionFoundation>
      </de.metaframe.common.sib.parameter.ContextExpression>
    </parameter>
    <parameter name="variable">
      <de.metaframe.jabc.framework.sib.parameter.ContextKey>
        <ContextKeyFoundation>
          <key>className</key>
          <scope>LOCAL</scope>
          <scopeMutable>true</scopeMutable>
        </ContextKeyFoundation>
      </de.metaframe.jabc.framework.sib.parameter.ContextKey>
    </parameter>
    <finalbranches>default</finalbranches>
    <finalbranches>error</finalbranches>
  </sib>
  <edge>
    <source>13f56336-847c-41e9-979b-1b6c73dc23e5</source>
    <target>8b9c1b28-46c3-4300-a29e-40a8255f0449</target>
    <point>75.0,525.0</point>
    <point>199.0,505.0</point>
    <branch>default</branch>
  </edge>
  <values/>
  <branch>
    <name>error</name>
    <branch>error</branch>
    <sib>ad9b9c21-91db-4af5-9d2c-291ad1a050ef</sib>
  </branch>
  <branch>
    <name>error</name>
    <branch>error</branch>
    <sib>b316cc76-c376-4517-9225-83d1324e2a57</sib>
  </branch>
  <branch>
    <name>error</name>
    <branch>error</branch>
    <sib>ce391528-54d4-4875-a460-bda3725e4ff3</sib>
  </branch>
  <branch>
    <name>error</name>
    <branch>error</branch>
    <sib>566db424-57e3-4760-be04-5c0e76bb3f60</sib>
  </branch>
  <branch>
    <name>error</name>
    <branch>error</branch>
    <sib>13f56336-847c-41e9-979b-1b6c73dc23e5</sib>
  </branch>
  <branch>
    <name>error</name>
    <branch>error</branch>
    <sib>8b9c1b28-46c3-4300-a29e-40a8255f0449</sib>
  </branch>
  <branch>
    <name>error</name>
    <branch>error</branch>
    <sib>2794558b-06bd-4d2f-905c-53bab38863fa</sib>
  </branch>
  <branch>
    <name>default</name>
    <branch>default</branch>
    <sib>2794558b-06bd-4d2f-905c-53bab38863fa</sib>
  </branch>
</model>